<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Development Guide &#8212; exodus-gw  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=32913b9a" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Deployment Guide" href="deployment.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="development-guide">
<span id="dev-guide"></span><h1>Development Guide<a class="headerlink" href="#development-guide" title="Link to this heading">¶</a></h1>
<p>This document contains useful info for developers contributing
to the exodus-gw project.</p>
<section id="running-exodus-gw-services-with-tox">
<h2>Running exodus-gw services with tox<a class="headerlink" href="#running-exodus-gw-services-with-tox" title="Link to this heading">¶</a></h2>
<p>A development instance of the exodus-gw service may be run locally
using tox. Commands are provided for running both the API and background
worker components of exodus-gw:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># runs uvicorn with hot reload</span>
tox<span class="w"> </span>-e<span class="w"> </span>dev-server

<span class="c1"># runs dramatiq worker with hot reload</span>
tox<span class="w"> </span>-e<span class="w"> </span>dev-worker
</pre></div>
</div>
<p>The services will use <code class="docutils literal notranslate"><span class="pre">exodus-gw.ini</span></code> from the source directory for
configuration, along with any <code class="docutils literal notranslate"><span class="pre">EXODUS_GW_*</span></code> environment variables,
as described in <a class="reference internal" href="deployment.html#deploy-guide"><span class="std std-ref">Deployment Guide</span></a>.</p>
<p>Note that tox will not start or manage any dependencies of exodus-gw.
A more complete development environment can be provided using systemd
units, as described below.</p>
</section>
<section id="systemd-based-development-environment">
<h2>Systemd-based development environment<a class="headerlink" href="#systemd-based-development-environment" title="Link to this heading">¶</a></h2>
<p>A systemd-based development environment is offered which allows running
an instance of exodus-gw along with its dependencies, via systemd
user units. This may be used as a lightweight alternative to running
a complete instance of the service in Kubernetes/OpenShift.</p>
<p>This development environment includes:</p>
<ul class="simple">
<li><p>exodus-gw uvicorn server (http)</p></li>
<li><p>sidecar proxy container (https) (optional)</p></li>
<li><p>exodus-gw dramatiq worker, for background tasks</p></li>
<li><p>postgres container</p></li>
<li><p>localstack container</p></li>
<li><p>exodus-lambda fakefront server (optional)</p></li>
<li><p>helpers for managing development certs</p></li>
</ul>
<p>Note: the sidecar proxy is only enabled when you instantiate the environment
from within Red Hat’s network. Otherwise, the service will only be available
via http.</p>
<section id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>The dev env is designed for use on currently supported versions of Fedora Workstation.</p></li>
<li><p>Your login sessions must make use of a systemd user manager.</p></li>
<li><p>You may need to install some packages. If so, the install script will list the needed
packages for you.</p></li>
<li><p>If you want exodus-lambda fakefront to be enabled, you must have a copy of the
<a class="reference external" href="https://github.com/release-engineering/exodus-lambda">exodus-lambda sources</a>
checked out as a sibling of the exodus-gw repository.</p></li>
</ul>
</section>
<section id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Link to this heading">¶</a></h3>
<p>In the exodus-gw repo, run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>scripts/systemd/install
</pre></div>
</div>
<p>If you’re missing any needed packages, the script may suggest some <code class="docutils literal notranslate"><span class="pre">dnf</span> <span class="pre">install</span></code>
commands for you to run.</p>
<p>If installation succeeds, various systemd user units will be installed and
set as dependencies of a new <code class="docutils literal notranslate"><span class="pre">exodus-gw</span></code> target. The script will also output a few
example commands to get you started with using the dev env.</p>
</section>
<section id="uninstallation">
<h3>Uninstallation<a class="headerlink" href="#uninstallation" title="Link to this heading">¶</a></h3>
<p>If you want to remove the dev env, run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>scripts/systemd/uninstall
</pre></div>
</div>
<p>This will stop any running services and remove the installed systemd user units.</p>
<p>If you also want to erase any persistent state used by the dev env (such as any
changes written to the DB and localstack), run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>scripts/systemd/clean
</pre></div>
</div>
</section>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h3>
<p>If you need to adjust the configuration of the development environment, such as
using custom ports for services to avoid conflicts, you can edit the environment
file at <code class="docutils literal notranslate"><span class="pre">$HOME/.config/exodus-gw-dev/.env</span></code>.</p>
<p>For example, if you need to run the development postgres server using a different
port, you may add to this file:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># use this port for postgres rather than default</span>
<span class="nv">EXODUS_GW_DB_SERVICE_PORT</span><span class="o">=</span><span class="m">8899</span>
</pre></div>
</div>
<p>The development environment installation process will generate a template file with
the most useful environment variables listed.</p>
</section>
<section id="cheat-sheet">
<h3>Cheat sheet<a class="headerlink" href="#cheat-sheet" title="Link to this heading">¶</a></h3>
<p>Various example commands are listed here which may be useful when working with
the development environment.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">start</span> <span class="pre">exodus-gw.target</span></code></p></td>
<td><p>Start all development services</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">--user</span> <span class="pre">'--unit=exodus-*'</span> <span class="pre">-f</span></code></p></td>
<td><p>Watch logs of all services</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cp</span> <span class="pre">~/.config/exodus-gw-dev/ca.crt</span> <span class="pre">/etc/pki/ca-trust/source/anchors/exodus-gw-dev.crt</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">update-ca-trust</span></code></p>
</td>
<td><p>Trust development CA certificate.</p>
<p>It is strongly recommended to ensure that HTTPS is used during development rather than HTTP,
and without disabling SSL verification. There are significant changes to behavior in boto
libraries when using HTTPS vs HTTP.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://localhost:8000/healthcheck</span></code></p></td>
<td><p>Sanity check for exodus-gw (http)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">https://localhost:8010/healthcheck</span></code></p></td>
<td><p>Sanity check for exodus-gw (https).</p>
<p>This should not require <code class="docutils literal notranslate"><span class="pre">--insecure</span></code> or other means of disabling SSL verification.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://localhost:8000/healthcheck-worker</span></code></p></td>
<td><p>Sanity check for background worker</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">--cert</span> <span class="pre">my.crt</span> <span class="pre">--key</span> <span class="pre">my.key</span> <span class="pre">https://localhost:8010/whoami</span></code></p></td>
<td><p>Sanity check of an exodus-gw endpoint using authentication.</p>
<p>If using the sidecar proxy provided on Red Hat’s internal network, this requires
you to have a valid certificate and key produced by RHCS.
The method of obtaining these is beyond the scope of this documentation.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">https://localhost:3377</span></code></p></td>
<td><p>Sanity check for localstack</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-I</span> <span class="pre">http://localhost:8049/_/cookie/test</span></code></p></td>
<td><p>Sanity check for fakefront; should give a 302 response, and does not require any
content to be loaded in the environment.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">scripts/localstack-init</span></code></p></td>
<td><p>Create resources in localstack.</p>
<p>The localstack environment is initially empty, which will make it impossible to
upload any objects. For upload to work with exodus-gw, you’ll want to create buckets
and DynamoDB tables matching the info in <code class="docutils literal notranslate"><span class="pre">exodus-gw.ini</span></code>. This script will create
those resources.</p>
<p>The script uses defaults which are only appropriate for the <code class="docutils literal notranslate"><span class="pre">test</span></code> environment
defined in the repo’s <code class="docutils literal notranslate"><span class="pre">exodus-gw.ini</span></code>. Check the other <code class="docutils literal notranslate"><span class="pre">localstack-*-init</span></code>
scripts if you need to create buckets/tables with other names.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">AWS_PROFILE=test</span> <span class="pre">aws</span> <span class="pre">--endpoint-url=https://localhost:3377</span> <span class="pre">s3</span> <span class="pre">ls</span> <span class="pre">s3://my-bucket</span></code></p></td>
<td><p>List files in localstack s3 bucket.</p>
<p>Can be used to check the outcome of an upload.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">AWS_PROFILE=test</span> <span class="pre">aws</span> <span class="pre">--endpoint-url=https://localhost:3377</span> <span class="pre">dynamodb</span> <span class="pre">scan</span> <span class="pre">--table-name</span> <span class="pre">my-table</span></code></p></td>
<td><p>Dump all content of a dynamodb table in localstack.</p>
<p>Can be used to check the outcome of a publish.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">examples/s3-upload</span> <span class="pre">--endpoint-url</span> <span class="pre">https://localhost:8010/upload</span> <span class="pre">--env</span> <span class="pre">test</span> <span class="pre">some-file</span></code></p></td>
<td><p>Upload an object via exodus-gw.</p>
<p>This will write to the localstack service.
If you’re not sure whether anything really happened, check the logs of
exodus-gw-localstack.service or use the <code class="docutils literal notranslate"><span class="pre">s3</span> <span class="pre">ls</span></code> command above.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">psql</span> <span class="pre">-h</span> <span class="pre">localhost</span> <span class="pre">-p</span> <span class="pre">3355</span> <span class="pre">-U</span> <span class="pre">exodus-gw</span></code></p></td>
<td><p>Connect to the postgres database.</p>
<p>The database will be empty until exodus-gw has started successfully at least once.</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">stop</span> <span class="pre">exodus-gw-db</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">~/.config/exodus-gw-dev/postgresql/</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">start</span> <span class="pre">exodus-gw.target</span></code></p>
</td>
<td><p>Clean database while leaving other data untouched.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">stop</span> <span class="pre">exodus-gw-localstack</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">~/.config/exodus-gw-dev/localstack/</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">start</span> <span class="pre">exodus-gw.target</span></code></p>
</td>
<td><p>Clean localstack while leaving other data untouched.</p>
<p>Don’t forget to recreate any deleted buckets.</p>
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="spoofing-authentication">
<h2>Spoofing authentication<a class="headerlink" href="#spoofing-authentication" title="Link to this heading">¶</a></h2>
<p>The exodus-gw service parses an <code class="docutils literal notranslate"><span class="pre">X-RhApiPlatform-CallContext</span></code> header for information
relating to authentication &amp; authorization; see <a class="reference internal" href="deployment.html#deploy-guide"><span class="std std-ref">Deployment Guide</span></a> for more info on
this scheme.</p>
<p>During development, arbitrary values for this header may be used to test the
behavior of endpoints with various roles. However, due to the format of this header,
generating these values by hand can be cumbersome.</p>
<p>To assist in this, a helper script is provided in the exodus-gw repo at
<code class="docutils literal notranslate"><span class="pre">scripts/call-context</span></code>. This script accepts any number of role names as arguments
and produces a header value which will produce an authenticated &amp; authorized request
using those roles.</p>
<p>For example, if we want to use <code class="docutils literal notranslate"><span class="pre">curl</span></code> to make a request to an endpoint needing
<code class="docutils literal notranslate"><span class="pre">qa-uploader</span></code> role, we can use the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;X-RhApiPlatform-CallContext: </span><span class="k">$(</span>scripts/call-context<span class="w"> </span>qa-uploader<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:8000/some/qa/endpoint
</pre></div>
</div>
<p>This approach is only necessary if you are accessing the service via http
(for example, if you don’t access to the sidecar container).
If you are accessing the service using https, the same certificates and keys as
used for production may be used in your local environment.</p>
</section>
<section id="disabling-migrations-during-development">
<h2>Disabling migrations during development<a class="headerlink" href="#disabling-migrations-during-development" title="Link to this heading">¶</a></h2>
<p>The exodus-gw schema in production is managed via alembic migrations.</p>
<p>When prototyping schema changes during development, it can be unreasonably
time-consuming to exclusively use migrations for schema changes. Therefore
it is possible to use a setting to disable migrations and instead use the
sqlalchemy model to populate your development DB.</p>
<p>Here is a recommended workflow which allows disabling migrations during
development of schema changes and only producing migrations once the schema
has been stabilized:</p>
<ul>
<li><p>Use the systemd-based dev env.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">EXODUS_GW_DB_MIGRATION_MODE=model</span></code> in your dev env (for example, add
this to <code class="docutils literal notranslate"><span class="pre">~/.config/exodus-gw-dev/.env</span></code>).</p>
<p>This disables migrations; it will cause your DB schema to be refreshed
from the latest sqlalchemy model every time the service starts.</p>
</li>
<li><p>If your model changes can’t be applied automatically (e.g. changing column types),
consider also setting <code class="docutils literal notranslate"><span class="pre">EXODUS_GW_DB_RESET=true</span></code> to completely drop and recreate
tables when the service starts.</p></li>
<li><p>Develop your changes until the schema is stable.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">alembic-autogen</span></code> or <code class="docutils literal notranslate"><span class="pre">scripts/alembic-autogen</span></code> to generate a migration.</p></li>
<li><dl class="simple">
<dt>Unset <code class="docutils literal notranslate"><span class="pre">EXODUS_GW_DB_MIGRATION_MODE</span></code> (and <code class="docutils literal notranslate"><span class="pre">EXODUS_GW_DB_RESET</span></code> if you set it).</dt><dd><ul class="simple">
<li><p>This re-enables migrations.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Restart the service to verify that your migration applies successfully.</p></li>
</ul>
<p>The resulting migration should be included in the same pull request as your
sqlalchemy model changes.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">exodus-gw</a></h1>



<p class="blurb">Publishing microservice for Red Hat's Content Delivery Network</p>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Development Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#running-exodus-gw-services-with-tox">Running exodus-gw services with tox</a></li>
<li class="toctree-l2"><a class="reference internal" href="#systemd-based-development-environment">Systemd-based development environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spoofing-authentication">Spoofing authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disabling-migrations-during-development">Disabling migrations during development</a></li>
</ul>
</li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/release-engineering/exodus-gw">Source</a></li>
    
    <li class="toctree-l1"><a href="genindex.html">Index</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="deployment.html" title="previous chapter">Deployment Guide</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2020, Red Hat.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/development.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/release-engineering/exodus-gw" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>